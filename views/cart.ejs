<%- include('index.ejs') %>
  <title>My Cart</title>
  </head>

  <body>
    <div class="navbar">
      <%- include('nav.ejs') %>
      <div class="profile">
        <% if (user) { %>
          <span>Welcome, <%= user.role %>
              <%= user.name %></span>
          <% if (user.role==='admin' ) { %>
            <a href="/admin/orders">All Orders</a>
            <% } else { %>
              <a href="/orders">My Orders</a>
              <% } %>
                <a href="/logout">Logout</a>
                <% } else { %>
                  <a href="/login">Login</a>
                  <% } %>
      </div>
    </div>

    <div class="container">
      <h1>Your Shopping Cart</h1>

      <% if (items.length===0) { %>
        <p style="text-align:center; margin-top:40px;">
          Your cart is empty.
          <a href="/" style="color:#2a9d8f; text-decoration:none;">Start Shopping</a>
        </p>
        <% } else { %>
          <div class="product-list">
            <% items.forEach(function(product) { %>
              <div class="product-card">
                <img src="<%= product.image %>" alt="<%= product.name %>">
                <h2>
                  <%= product.name %>
                </h2>
                <p><strong>$<%= product.price.toFixed(2) %></strong></p>

                <p>Quantity: <%= product.quantity %>
                </p>
                <p>Subtotal: <strong>$<%= product.subtotal.toFixed(2) %></strong></p>

                <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö (‡πÉ‡∏ä‡πâ fetch DELETE) -->
                <button class="remove-btn" data-id="<%= product.id %>"
                  style="background-color:#d9534f; margin-top:10px;">
                  Remove
                </button>
              </div>
              <% }) %>
          </div>

          <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° -->
          <div style="text-align:right; margin-top:30px;">
            <h2>Total: $<%= total.toFixed(2) %>
            </h2>

            <form action="/order/create" method="POST" style="margin-top:10px;">
              <button type="submit" style="background-color:#2a9d8f;">Checkout</button>
            </form>
          </div>
          <% } %>
    </div>

    <!-- ‚úÖ Script ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Remove -->
    <script>
      document.querySelectorAll(".remove-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const productID = btn.getAttribute("data-id");

          if (!confirm("Remove this item from cart?")) return;

          try {
            const res = await fetch(`/api/cart/items/${productID}`, {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
              credentials: 'include' // ‚úÖ ‡∏™‡πà‡∏á cookie ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
            });

            if (res.ok) {
              alert("üóëÔ∏è Item removed from cart!");
              location.reload();
            } else {
              const err = await res.json();
              alert("‚ùå Failed to remove: " + (err.message || res.statusText));
            }
          } catch (error) {
            console.error(error);
            alert("‚ö†Ô∏è Error removing item");
          }
        });
      });

    </script>
  </body>

  </html>