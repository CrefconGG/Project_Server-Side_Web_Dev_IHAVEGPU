name: Notify Discord on Push

on:
  push:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send push info to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          AUTHOR="${{ github.actor }}"
          COMMIT_URL="${{ github.event.head_commit.url }}"
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)

          # ‡∏î‡∏∂‡∏á commit ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô push
          COMMITS=$(echo '${{ toJson(github.event.commits) }}' | jq -r '.[] | "- [" + .id[0:7] + "](" + .url + ") " + .message + " (by " + .author.name + ")"' | head -n 5)

          # ‡∏ñ‡πâ‡∏≤ push ‡∏´‡∏•‡∏≤‡∏¢ commit ‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏≠‡∏±‡∏ô
          CONTENT="üì¢ **New push to $REPO**\nBranch: \`$BRANCH\`\nBy: $AUTHOR\n\nCommits:\n$COMMITS"

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$(jq -n --arg content "$CONTENT" '{content:$content}')" \
               "$DISCORD_WEBHOOK"
