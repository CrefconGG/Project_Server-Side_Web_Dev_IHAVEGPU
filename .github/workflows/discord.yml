name: ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Discord ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£ Push

on:
  push:
    branches:
      - '**'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: ‡∏™‡πà‡∏á Commit ‡πÑ‡∏õ Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # -------------------------------
          # ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á Push
          # -------------------------------
          REPO="${{ github.repository }}"          # repo ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å push (‡πÄ‡∏ä‡πà‡∏ô user/myrepo)
          BRANCH="${{ github.ref_name }}"          # branch ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å push (‡πÄ‡∏ä‡πà‡∏ô main)
          AUTHOR="${{ github.actor }}"             # ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà push
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)   # commit id ‡∏¢‡πà‡∏≠

          # -------------------------------
          # ‡∏î‡∏∂‡∏á commit messages ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô push
          # -------------------------------
          COMMITS=$(echo '${{ toJson(github.event.commits) }}' \
            | jq -r '.[] | "- [" + .id[0:7] + "](\" + .url + ") " + .message + " (by " + .author.name + ")"' \
            | head -n 5)

          # -------------------------------
          # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Discord
          # -------------------------------
          CONTENT="üì¢ **‡∏°‡∏µ‡∏Å‡∏≤‡∏£ Push ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà $REPO**\nBranch: \`$BRANCH\`\n‡πÇ‡∏î‡∏¢: $AUTHOR\n\nCommits:\n$COMMITS"

          # ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö suppress embeds
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$(jq -n --arg content "$CONTENT" '{content:$content, flags:4096}')" \
               "$DISCORD_WEBHOOK"

